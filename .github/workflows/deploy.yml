name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Tag (e.g. 1.0.0 or latest)"
        required: true
        default: "latest"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          TAG: ${{ github.event.inputs.image_tag }}
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.USER }}@${{ secrets.HOST }} <<'EOF'
          set -e
          APP_NAME=mp3-joiner
          IMAGE="ghcr.io/${{ github.repository }}:${TAG}"

          docker pull "$IMAGE"

          docker stop $APP_NAME || true
          docker rm $APP_NAME || true

          mkdir -p ~/mp3-joiner-logs ~/mp3-tokens

          docker run -d --name $APP_NAME \
            -p 5001:5001 \
            -v ~/mp3-joiner-logs:/var/logs/mp3_joiner \
            -v ~/mp3-tokens:/app/tokens \
            -e USER_LOG_PATH=/var/logs/mp3_joiner \
            -e TOKEN_FILE_PATH=/app/tokens/allowed_tokens.txt \
            -e SECRET_KEY=${{ secrets.SECRET_KEY }} \
            "$IMAGE"
          EOF
