name: Deploy to VPS

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g. v1.0.0 or latest)"
        required: true
        default: "latest"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          TAG: ${{ github.event.inputs.image_tag }}
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.USER }}@${{ secrets.HOST }} <<'EOF'
          set -e
          APP_DIR=/srv/mp3-joiner
          APP_NAME=mp3-joiner
          IMAGE="ghcr.io/${{ github.repository }}:${TAG}"

          if [ -n "${{ secrets.GHCR_USERNAME }}" ] && [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
          fi

          mkdir -p "$APP_DIR"
          cd "$APP_DIR"

          export TAG="${TAG:-latest}"
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml up -d

          sleep 3
          curl -fsS http://127.0.0.1:5001/healthz || (docker logs \$(docker ps -q --filter name=${APP_NAME}) && exit 1)
          EOF
